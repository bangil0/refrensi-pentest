#!/bin/bash
export DEBIAN_FRONTEND=noninteractive

# Tambahkan repository PHP ( PPA onrej )
apt-get -y install software-properties-common
add-apt-repository -y ppa:ondrej/php
apt-get update --fix-missing

# Install tzdata (Timezone)
apt-get install -y tzdata
ln -fs /usr/share/zoneinfo/Asia/Jakarta /etc/localtime
dpkg-reconfigure --frontend noninteractive tzdata

# Install Apache2
apt-get -y install apache2

# Enable Apache Module
a2enmod alias rewrite proxy_fcgi setenvif

# Restart Apache
service apache2 restart

# Cegah Error default PHP-FPM Socket
mkdir /run/php

# Install PHP 5.6
apt-get -y install php5.6 php5.6-fpm php5.6-cli php5.6-xsl php5.6-json php5.6-intl php5.6-mbstring php5.6-readline php5.6-xml php5.6-zip php5.6-gd php5.6-mcrypt php5.6-curl php5.6-mysql
echo 'Define php56 "proxy:unix:/run/php/php5.6-fpm.sock|fcgi://localhost"' >> /etc/apache2/conf-available/phpHandlers.conf
service php5.6-fpm restart

# Install PHP 7.0
apt-get -y install php7.0 php7.0-fpm php7.0-cli php7.0-xsl php7.0-json php7.0-intl php7.0-mbstring php7.0-readline php7.0-xml php7.0-zip php7.0-gd php7.0-mcrypt php7.0-curl php7.0-mysql
echo 'Define php70 "proxy:unix:/run/php/php7.0-fpm.sock|fcgi://localhost"' >> /etc/apache2/conf-available/phpHandlers.conf
service php7.0-fpm restart

# Install PHP 7.1
apt-get -y install php7.1 php7.1-fpm php7.1-cli php7.1-xsl php7.1-json php7.1-intl php7.1-mbstring php7.1-readline php7.1-xml php7.1-zip php7.1-gd php7.1-mcrypt php7.1-curl php7.1-mysql
echo 'Define php71 "proxy:unix:/run/php/php7.1-fpm.sock|fcgi://localhost"' >> /etc/apache2/conf-available/phpHandlers.conf
service php7.1-fpm restart

# Install PHP 7.2
apt-get -y install php7.2 php7.2-fpm php7.2-cli php7.2-xsl php7.2-json php7.2-intl php7.2-mbstring php7.2-readline php7.2-xml php7.2-zip php7.2-gd php7.2-curl php7.2-mysql
echo 'Define php72 "proxy:unix:/run/php/php7.2-fpm.sock|fcgi://localhost"' >> /etc/apache2/conf-available/phpHandlers.conf
service php7.2-fpm restart

# Install PHP 7.3
apt-get -y install php7.3 php7.3-fpm php7.3-cli php7.3-xsl php7.3-json php7.3-intl php7.3-mbstring php7.3-readline php7.3-xml php7.3-zip php7.3-gd php7.3-curl php7.3-mysql
echo 'Define php73 "proxy:unix:/run/php/php7.3-fpm.sock|fcgi://localhost"' >> /etc/apache2/conf-available/phpHandlers.conf
service php7.3-fpm restart

# Enable .htaccess
sed -i '/<Directory \/var\/www\/>/,/<\/Directory>/ s/AllowOverride None/AllowOverride all/' /etc/apache2/apache2.conf

# Enable phpHandlers
a2enconf phpHandlers
service apache2 reload
